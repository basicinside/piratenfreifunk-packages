#!/bin/sh
# versioncheck stolen from remote_update
local D2='\([0-9]\{2\}\)'                                           
local D4='\([0-9]\{4\}\)'                                           

if [ `uci get manager.heartbeat.enabled` == "1" ]; then
	#gather information
	server=`uci get manager.heartbeat.server`
	node_id=`uci get system.@system[0].nodeid`
	hostname=`uci get system.@system[0].hostname`
	version=`sed -ne "s!.*$D4/$D2/$D2 $D2:$D2.*!\\1\\2\\3\\4\\5!p;t" /rom/etc/banner`
	lat=`uci show olsrd|grep .lat=|cut -d = -f2`
	lon=`uci show olsrd|grep .lon=|cut -d = -f2`
	neighbors=`echo |nc 127.0.0.1 2006|grep YES|wc -l`
	clients=`cat /tmp/machashes|sort|uniq|wc -l`

	if  wget -s "$server/nodes/status/update?node_id=$node_id&name=$hostname&lat=$lat&lon=$lon&version=$version&neighbors=$neighbors&clients=$clients";  then
		#reset client count
		rm /tmp/machashes
	fi
fi
